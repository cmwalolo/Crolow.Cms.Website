@using Crolow.Cms.Core.Controllers.Api.CrolowForm
@using Crolow.Cms.Core.HtmlHelpers.Dictionary
@using Crolow.Cms.Core.Models.ViewModel
@inject Umbraco.Cms.Core.UmbracoApiControllerTypeCollection _controllers;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<CrolowFormModel>

<div class="col-12">
    <h2>Commentaires</h2>
    <div class="row pb-3">
        @foreach (var comment in Model.Comments)
        {
            <div class="comment col-12 mt-4 text-justify float-left">
                <h4>@comment.Name</h4>
                <p>@comment.Date.ToString("dd-MM-yyyy")</p>
                <p>@comment.Message</p>
            </div>
        }
    </div>
    <div class="row pb-3">
        <div class="comment mt-4 col-12">
            <form id="form1">
                <input type="hidden" name="BlogPostUmbracoId" value="@Model.Id" />
                <input type="hidden" name="Website" value="" />
                <h4>Laissez un commentaire</h4>
                <div class="col-12 form-group">
                    <label class="mb-2" for="message">Message</label>
                    <textarea name="message" id="message" msg cols="30" rows="5" class="form-control" style="background-color: black;"></textarea>
                </div>
                <div class="form-group">
                    <label class="mb-2" for="name">Votre nom</label>
                    <input type="text" name="name" id="fullname" class="form-control">
                </div>
                <div class="form-group">
                    <label class="mb-2" for="email">Email</label>
                    <input type="text" name="email" id="email" class="form-control">
                </div>
                <div class="form-inline">
                    <input type="checkbox" name="subscribe" id="checkbx" class="mr-1">
                    <label for="subscribe">Inscrivez-moi à la newsletter</label>
                </div>
                <div class="form-group">
                    <button type="button" onclick="handleFormSubmit(this)" id="post" class="btn">
                        <span class="bi-send bi-large" aria-hidden="true"></span>
                        Postez le commentaire
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Example POST method implementation:
    async function postData(url = "", data = {}) {
        // Default options are marked with *
        const response = await fetch(url, {
            method: "POST", // *GET, POST, PUT, DELETE, etc.
            mode: "cors", // no-cors, *cors, same-origin
            cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
            credentials: "same-origin", // include, *same-origin, omit
            headers: {
                "Content-Type": "application/json",
                // 'Content-Type': 'application/x-www-form-urlencoded',
            },
            redirect: "follow", // manual, *follow, error
            referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
            body: JSON.stringify(data), // body data type must match "Content-Type" header
        });
        //return await response.json(); // parses JSON response into native JavaScript objects
    }
    @{
        var url = Url.GetUmbracoApiService<CrolowFormApiController>(_controllers, "InsertComment");
    }


    document.addEventListener("DOMContentLoaded", () => {
        form = document.getElementById('form1');
        form.removeEventListener('submit', handleFormSubmit, true);
        form.addEventListener('submit', handleFormSubmit);
    });

    function handleFormSubmit(element) {
        $(element).attr("disabled", true);
        var data =
        {
            BlogPostUmbracoId: document.getElementsByName('BlogPostUmbracoId')[0].value,
            Name: document.getElementsByName('name')[0].value,
            Message: document.getElementsByName('message')[0].value,
            Email: document.getElementsByName('email')[0].value,
            Website: "crolow.pix",
            Application: "MediaComment"

        }

        postData("@url", data);
        return false;
    }

</script>